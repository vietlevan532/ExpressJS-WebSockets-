<!-- Start Content-->
<div class="container-fluid">

    <!-- start page title -->
    <div class="row">
                            <div class="col-12">
                                <div class="page-title-box">
                                    <div class="page-title-right">
                                        <ol class="breadcrumb m-0">
                                            <li class="breadcrumb-item"><a href="javascript: void(0);">Hyper</a></li>
                                            <li class="breadcrumb-item active">Chat</li>
                                        </ol>
                                    </div>
                                    <h4 class="page-title">Chat</h4>
                                </div>
                            </div>
    </div>
    <!-- end page title -->

    <div class="row">
                            <!-- start chat users-->
                            <div class="col-xl-3 col-lg-6 order-lg-1 order-xl-1">
                                <div class="card">
                                    <div class="card-body p-0">
                                        <ul class="nav nav-tabs nav-bordered">
                                            <li class="nav-item">
                                                <a href="#allUsers" data-toggle="tab" aria-expanded="false" class="nav-link active py-2">
                                                    All
                                                </a>
                                            </li>
                                            <li class="nav-item">
                                                <a href="#favUsers" data-toggle="tab" aria-expanded="true" class="nav-link py-2">
                                                    Favourties
                                                </a>
                                            </li>
                                            <li class="nav-item">
                                                <a href="#friendUsers" data-toggle="tab" aria-expanded="true" class="nav-link py-2">
                                                    Friends
                                                </a>
                                            </li>
                                        </ul> <!-- end nav-->
                                        <div class="tab-content">
                                            <div class="tab-pane show active p-3" id="newpost">

                                                <!-- start search box -->
                                                <div class="app-search">
                                                    <form>
                                                        <div class="form-group position-relative">
                                                            <input type="text" class="form-control"
                                                                placeholder="People, groups & messages..." />
                                                            <span class="mdi mdi-magnify search-icon"></span>
                                                        </div>
                                                    </form>
                                                </div>
                                                <!-- end search box -->

                                                <!-- users -->
                                                <div class="row">
                                                    <div class="col">
                                                        <div data-simplebar style="max-height: 550px">
                                                            

                                                            {{#each users}}
                                                                <a href="#" class="text-body user-link" data-id="{{this._id}}">
                                                                    <div class="media bg-light p-2"> <!-- class="media mt-1 p-2" for conversation checked -->
                                                                        <img src="{{this.avatar}}" class="mr-2 rounded-circle" height="48" width="48" alt="{{this.name}}" />
                                                                        {{#if this.status}}
                                                                            <sup class="online-status" id="{{this._id}}-status"></sup>
                                                                        {{else}}
                                                                            <sup class="offline-status" id="{{this._id}}-status"></sup>
                                                                        {{/if}}
                                                                        <div class="media-body">
                                                                            <h5 class="mt-0 mb-0 font-14">
                                                                                <span class="float-right text-muted font-12">5:30am</span>
                                                                                {{this.name}}
                                                                            </h5>
                                                                            <p class="mt-1 mb-0 text-muted font-14">
                                                                                {{!-- <span class="w-25 float-right text-right"><span class="badge badge-danger-lighten">3</span></span> --}}
                                                                                <span class="w-75">Hey! a reminder for tomorrow's meeting...</span>
                                                                            </p>
                                                                        </div>
                                                                    </div>
                                                                </a>
                                                            {{/each}}


                                                        </div> <!-- end slimscroll-->
                                                    </div> <!-- End col -->
                                                </div>
                                                <!-- end users -->
                                            </div> <!-- end Tab Pane-->
                                        </div> <!-- end tab content-->
                                    </div> <!-- end card-body-->
                                </div> <!-- end card-->
                            </div>
                            <!-- end chat users-->

                            <!-- chat area -->
                            <div class="col-xl-6 col-lg-12 order-lg-2 order-xl-1" id="chat-area">
                                <div class="card">
                                    <div class="card-body">
                                        <ul class="conversation-list" id="chat-container">
                                            {{!-- <li class="clearfix">
                                                <div class="chat-avatar">
                                                    <img src="assets/images/users/avatar-5.jpg" alt="Shreyu N" class="rounded" />
                                                    <i>10:04</i>
                                                </div>
                                                <div class="conversation-text">
                                                    <div class="ctext-wrap">
                                                        <i>Shreyu N</i>
                                                        <p>
                                                            We can also discuss about the presentation talk format if you have some extra mins
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="conversation-actions dropdown">
                                                    <button class="btn btn-sm btn-link" data-toggle="dropdown"
                                                        aria-expanded="false"><i class='uil uil-ellipsis-v'></i></button>

                                                    <div class="dropdown-menu dropdown-menu-right">
                                                        <a class="dropdown-item" href="#">Copy Message</a>
                                                        <a class="dropdown-item" href="#">Edit</a>
                                                        <a class="dropdown-item" href="#">Delete</a>
                                                    </div>
                                                </div>
                                            </li>
                                            <li class="clearfix odd">
                                                <div class="chat-avatar">
                                                    <img src="assets/images/users/avatar-1.jpg" alt="dominic" class="rounded" />
                                                    <i>10:05</i>
                                                </div>
                                                <div class="conversation-text">
                                                    <div class="ctext-wrap">
                                                        <i>Dominic</i>
                                                        <p>
                                                            3pm it is. Sure, let's discuss about presentation format, it would be great to finalize today. 
                                                            I am attaching the last year format and assets here...
                                                        </p>
                                                    </div>
                                                    <div class="card mt-2 mb-1 shadow-none border text-left">
                                                        <div class="p-2">
                                                            <div class="row align-items-center">
                                                                <div class="col-auto">
                                                                    <div class="avatar-sm">
                                                                        <span class="avatar-title rounded">
                                                                            .ZIP
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                <div class="col pl-0">
                                                                    <a href="javascript:void(0);"
                                                                        class="text-muted font-weight-bold">Hyper-admin-design.zip</a>
                                                                    <p class="mb-0">2.3 MB</p>
                                                                </div>
                                                                <div class="col-auto">
                                                                    <!-- Button -->
                                                                    <a href="javascript:void(0);"
                                                                        class="btn btn-link btn-lg text-muted">
                                                                        <i class="dripicons-download"></i>
                                                                    </a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="conversation-actions dropdown">
                                                    <button class="btn btn-sm btn-link" data-toggle="dropdown"
                                                        aria-expanded="false"><i class='uil uil-ellipsis-v'></i></button>

                                                    <div class="dropdown-menu">
                                                        <a class="dropdown-item" href="#">Copy Message</a>
                                                        <a class="dropdown-item" href="#">Edit</a>
                                                        <a class="dropdown-item" href="#">Delete</a>
                                                    </div>
                                                </div>
                                   --}} </ul> 

                                        <div class="row">
                                            <div class="col">
                                                <div class="mt-2 bg-light p-3 rounded">
                                                    <form class="needs-validation" novalidate="" id="chat-form"
                                                        id="chat-form">
                                                        <div class="row">
                                                            <div class="col mb-2 mb-sm-0">
                                                                <input type="text" class="form-control border-0" name="message" id="message" placeholder="Enter your text" required="">
                                                                {{!-- <div class="invalid-feedback">
                                                                    Please enter your messsage
                                                                </div> --}}
                                                            </div>
                                                            <div class="col-sm-auto">
                                                                <div class="btn-group">
                                                                    <a href="#" class="btn btn-light"><i class="uil uil-paperclip"></i></a>
                                                                    <a href="#" class="btn btn-light"> <i class='uil uil-smile'></i> </a>
                                                                    <button type="submit" class="btn btn-success chat-send btn-block"><i class='uil uil-message'></i></button>
                                                                </div>
                                                            </div> <!-- end col -->
                                                        </div> <!-- end row-->
                                                    </form>
                                                </div> 
                                            </div> <!-- end col-->
                                        </div>
                                        <!-- end row -->
                                    </div> <!-- end card-body -->
                                </div> <!-- end card -->
                            </div>
                            <!-- end chat area-->

                            <!-- start user detail -->
                            <div class="col-xl-3 col-lg-6 order-lg-1 order-xl-2" id="user-detail">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="dropdown float-right">
                                            <a href="#" class="dropdown-toggle arrow-none card-drop" data-toggle="dropdown" aria-expanded="false">
                                                <i class="mdi mdi-dots-horizontal"></i>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-right">
                                                <!-- item-->
                                                <a href="javascript:void(0);" class="dropdown-item">View full</a>
                                                <!-- item-->
                                                <a href="javascript:void(0);" class="dropdown-item">Edit Contact Info</a>
                                                <!-- item-->
                                                <a href="javascript:void(0);" class="dropdown-item">Remove</a>
                                            </div>
                                        </div>

                                        <div class="mt-3 text-center">
                                            <img src="assets/images/users/avatar-5.jpg" alt="shreyu"
                                                class="img-thumbnail avatar-lg rounded-circle" />
                                            <h4>Shreyu N</h4>
                                            <button class="btn btn-primary btn-sm mt-1"><i class='uil uil-envelope-add mr-1'></i>Send Email</button>
                                            <p class="text-muted mt-2 font-14">Last Interacted: <strong>Few hours back</strong></p>
                                        </div>

                                        <div class="mt-3">
                                            <hr class="" />

                                            <p class="mt-4 mb-1"><strong><i class='uil uil-at'></i> Email:</strong></p>
                                            <p>support@coderthemes.com</p>

                                            <p class="mt-3 mb-1"><strong><i class='uil uil-phone'></i> Phone Number:</strong></p>
                                            <p>+1 456 9595 9594</p>

                                            <p class="mt-3 mb-1"><strong><i class='uil uil-location'></i> Location:</strong></p>
                                            <p>California, USA</p>

                                            <p class="mt-3 mb-1"><strong><i class='uil uil-globe'></i> Languages:</strong></p>
                                            <p>English, German, Spanish</p>

                                            <p class="mt-3 mb-2"><strong><i class='uil uil-users-alt'></i> Groups:</strong></p>
                                            <p>
                                                <span class="badge badge-success-lighten p-1 font-14">Work</span>
                                                <span class="badge badge-primary-lighten p-1 font-14">Friends</span>
                                            </p>
                                        </div>
                                    </div> <!-- end card-body -->
                                </div> <!-- end card-->
                            </div> <!-- end col -->
                            <!-- end user detail -->

                            <!-- welcome content -->
                            <div class="col-xl-9 col-lg-12 order-lg-2 order-xl-1" id="welcome-content" style="text-align: center;">
                                <!-- your welcome content here -->
                                <h1>Welcome to the chat app!</h1>
                            </div>
    </div> <!-- end row-->


</div> <!-- container -->

{{!-- data-toggle="modal" data-target="#deleteChatModal" --}}

<!-- Modal -->
<div class="modal fade" id="deleteChatModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Remove Message</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="" id="delete-chat-form">
        <div class="modal-body">
            <input type="text" name="id" id="delete-message-id">
            <p>Are you sure you want to remove this message?</p>
            <p><b id="delete-message"></b></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary">Remove</button>
        </div>
      </form>
    </div>
  </div>
</div>




<script>

    var sender = '{{user._id}}';
    var receiver;
    var socket = io('/user-namespace', {
        auth: {
            token: '{{user._id}}'
        }
    });

    $(document).ready(function () {
        // Ẩn chat area và user detail ban đầu
        $("#chat-area").hide();
        $("#user-detail").hide();

        // Xử lý sự kiện khi người dùng nhấp vào thẻ a trong phần user
        $("a.user-link").click(function () {

            var userId = $(this).attr('data-id');
            receiver = userId;

            $("#chat-area").show();
            $("#user-detail").show();
            $("#welcome-content").hide();

            socket.emit('existConversation', { sender: sender, receiver: receiver })

        });
    });

    //update user online status
    socket.on('getOnlineUser', function(data) {
        $('#' + data.user_id + '-status').text('');
        $('#' + data.user_id + '-status').removeClass('offline-status');
        $('#' + data.user_id + '-status').addClass('online-status');
    });

    socket.on('getOfflineUser', function(data) {
        $('#' + data.user_id + '-status').text('');
        $('#' + data.user_id + '-status').addClass('offline-status');
        $('#' + data.user_id + '-status').removeClass('online-status');
    });

    //save message of user
    $('#chat-form').submit(function(event) {
        event.preventDefault();
        var message = $('#message').val();
        $.ajax({
            url: '/conversations/save-message',
            type: 'POST',
            data: { sender: sender, receiver: receiver, message:message },
            success: function(response) {
                if (response.success) {
                    console.log(response.data.message);
                    $('#message').val('');
                    let conversation = response.data.message;
                    let html = `
                        <li class="clearfix odd">
                            <div class="chat-avatar">
                                <img src="assets/images/users/avatar-1.jpg" alt="dominic" class="rounded" />
                                <i>10:05</i>
                            </div>
                            <div class="conversation-text">
                                <div class="ctext-wrap">
                                    <i>Dominic</i>
                                    <p>
                                        `+ conversation +`
                                    </p>
                                </div>
                            </div>
                            <div class="conversation-actions dropdown">
                                <button class="btn btn-sm btn-link" data-toggle="dropdown"
                                    aria-expanded="false"><i class='uil uil-ellipsis-v'></i></button>

                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#">Copy Message</a>
                                    <a class="dropdown-item" href="#">Edit</a>
                                    <a class="dropdown-item" href="#">Delete</a>
                                </div>
                            </div>
                        </li>
                    `;
                    $('#chat-container').append(html);
                    socket.emit('newMessage', response.data);
                    $('#chat-container').scrollTop($('#chat-container')[0].scrollHeight);
                } else {
                    alert(data.msg);
                }
            }
        });
    });

    // load new message
    socket.on('loadNewMessage', function(data) {
        if (sender == data.receiver && receiver == data.sender) {
            let html = `
                <li class="clearfix">
                    <div class="chat-avatar">
                        <img src="assets/images/users/avatar-5.jpg" alt="Shreyu N" class="rounded" />
                        <i>10:04</i>
                    </div>
                    <div class="conversation-text">
                        <div class="ctext-wrap">
                            <i>Shreyu N</i>
                            <p>
                                `+ data.message +`
                            </p>
                        </div>
                    </div>
                    <div class="conversation-actions dropdown">
                        <button class="btn btn-sm btn-link" data-toggle="dropdown"
                            aria-expanded="false"><i class='uil uil-ellipsis-v'></i></button>

                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="#">Copy Message</a>
                            <a class="dropdown-item" href="#">Edit</a>
                            <a class="dropdown-item" href="#">Delete</a>
                        </div>
                    </div>
                </li>
            `;
            $('#chat-container').append(html);
            $('#chat-container').scrollTop($('#chat-container')[0].scrollHeight);
        }
    });

    // load old conversation data
    socket.on('loadConversations', function(data) {
        $('#chat-container').html('');

        var conversations = data.conversations;
        let html = '';
        for(let i = 0; i < conversations.length; i++) {
            let addClass = '';
            let addClassDropMenu = '';
            if (conversations[i]['sender'] == sender) {
                addClass = 'clearfix odd';
                addClassDropMenu = 'dropdown-menu-right';
            } else {
                addClass = 'clearfix';
                addClassDropMenu = 'dropdown-menu-left';
            }

            html += `
                <li class="`+ addClass +`" id="`+conversations[i]['_id']+`">
                    <div class="chat-avatar">
                        <img src="assets/images/users/avatar-5.jpg" alt="Shreyu N" class="rounded" />
                        <i>10:04</i>
                    </div>
                    <div class="conversation-text">
                        <div class="ctext-wrap">
                            <i>Shreyu N</i>
                            <p>
                                `+ conversations[i]['message'] +`
                            </p>
                        </div>
                    </div>`;
            if (conversations[i]['sender'] == sender) {
                html += `
                    <div class="conversation-actions dropdown">
                        <button class="btn btn-sm btn-link" data-toggle="dropdown"
                            aria-expanded="false"><i class='uil uil-ellipsis-v'></i></button>

                        <div class="dropdown-menu `+addClassDropMenu+`">
                            <a class="dropdown-item" href="#">Copy Message</a>
                            <a class="dropdown-item" href="#">Edit</a>
                            <a class="dropdown-item" href="#">Delete</a>
                        </div>
                    </div>
                `;
            }
            html += `
                </li>
            `;
        }
        $('#chat-container').append(html);
        $('#chat-container').scrollTop($('#chat-container')[0].scrollHeight);
    });

</script>
